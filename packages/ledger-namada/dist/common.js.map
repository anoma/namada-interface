{"version":3,"file":"common.js","sourceRoot":"","sources":["../src/common.ts"],"names":[],"mappings":";;;AAAA;;;;;;;;;;;;;;mFAcmF;AACtE,QAAA,UAAU,GAAG,GAAG,CAAA;AAEhB,QAAA,YAAY,GAAG;IAC1B,IAAI,EAAE,IAAI;IACV,GAAG,EAAE,IAAI;IACT,IAAI,EAAE,IAAI;CACX,CAAA;AAEY,QAAA,SAAS,GAAG;IACvB,aAAa,EAAE,IAAI;IACnB,sBAAsB,EAAE,IAAI;CAC7B,CAAA;AAEY,QAAA,SAAS,GAAG;IACvB,OAAO,EAAE,IAAI;CACd,CAAA;AAED,qCAAqC;AACxB,QAAA,cAAc,GAAG;IAC5B,OAAO,EAAE,IAAI;CACd,CAAA;AAEY,QAAA,UAAU,GAAG;IACxB,OAAO,EAAE,MAAM;CAChB,CAAA;AAOD,IAAY,WAuBX;AAvBD,WAAY,WAAW;IACrB,yDAAc,CAAA;IACd,+DAAiB,CAAA;IACjB,2FAA+B,CAAA;IAC/B,2EAAuB,CAAA;IACvB,yDAAc,CAAA;IACd,oDAAY,CAAA;IACZ,yDAAiB,CAAA;IACjB,iEAAqB,CAAA;IACrB,2EAA0B,CAAA;IAC1B,qEAAuB,CAAA;IACvB,+DAAoB,CAAA;IACpB,+DAAoB,CAAA;IACpB,iFAA6B,CAAA;IAC7B,mEAAsB,CAAA;IACtB,qFAA+B,CAAA;IAC/B,+EAA4B,CAAA;IAC5B,iEAAqB,CAAA;IACrB,+DAAoB,CAAA;IACpB,uFAAgC,CAAA;IAChC,qFAA+B,CAAA;IAC/B,iEAAqB,CAAA;IACrB,uEAAwB,CAAA;AAC1B,CAAC,EAvBW,WAAW,2BAAX,WAAW,QAuBtB;AAEY,QAAA,iBAAiB,GAAG;IAC/B,CAAC,WAAW,CAAC,UAAU,CAAC,EAAE,cAAc;IACxC,CAAC,WAAW,CAAC,aAAa,CAAC,EAAE,kBAAkB;IAC/C,CAAC,WAAW,CAAC,2BAA2B,CAAC,EAAE,gCAAgC;IAC3E,CAAC,WAAW,CAAC,mBAAmB,CAAC,EAAE,wBAAwB;IAC3D,CAAC,WAAW,CAAC,UAAU,CAAC,EAAE,cAAc;IACxC,CAAC,WAAW,CAAC,OAAO,CAAC,EAAE,SAAS;IAChC,CAAC,WAAW,CAAC,QAAQ,CAAC,EAAE,WAAW;IACnC,CAAC,WAAW,CAAC,YAAY,CAAC,EAAE,gBAAgB;IAC5C,CAAC,WAAW,CAAC,iBAAiB,CAAC,EAAE,qBAAqB;IACtD,CAAC,WAAW,CAAC,cAAc,CAAC,EAAE,iBAAiB;IAC/C,CAAC,WAAW,CAAC,WAAW,CAAC,EAAE,cAAc;IACzC,CAAC,WAAW,CAAC,WAAW,CAAC,EAAE,cAAc;IACzC,CAAC,WAAW,CAAC,oBAAoB,CAAC,EAAE,yBAAyB;IAC7D,CAAC,WAAW,CAAC,aAAa,CAAC,EAAE,iBAAiB;IAC9C,CAAC,WAAW,CAAC,sBAAsB,CAAC,EAAE,0BAA0B;IAChE,CAAC,WAAW,CAAC,mBAAmB,CAAC,EAAE,sBAAsB;IACzD,CAAC,WAAW,CAAC,YAAY,CAAC,EAAE,gBAAgB;IAC5C,CAAC,WAAW,CAAC,WAAW,CAAC,EAAE,eAAe;IAC1C,CAAC,WAAW,CAAC,uBAAuB,CAAC,EAAE,2BAA2B;IAClE,CAAC,WAAW,CAAC,sBAAsB,CAAC,EAAE,8BAA8B;IACpE,CAAC,WAAW,CAAC,YAAY,CAAC,EAAE,eAAe;IAC3C,CAAC,WAAW,CAAC,eAAe,CAAC,EAAE,mBAAmB;CACnD,CAAA;AAED,SAAgB,iBAAiB,CAAC,UAAuB;IACvD,IAAI,UAAU,IAAI,yBAAiB;QAAE,OAAO,yBAAiB,CAAC,UAAU,CAAC,CAAA;IACzE,OAAO,wBAAwB,UAAU,EAAE,CAAA;AAC7C,CAAC;AAHD,8CAGC;AAED,SAAS,MAAM,CAAC,CAAM;IACpB,OAAO,OAAO,CAAC,KAAK,QAAQ,IAAI,CAAC,KAAK,IAAI,IAAI,CAAC,CAAC,CAAC,YAAY,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,YAAY,IAAI,CAAC,CAAA;AAC7F,CAAC;AAED,SAAgB,oBAAoB,CAAC,QAAa;IAChD,IAAI,QAAQ,EAAE;QACZ,IAAI,MAAM,CAAC,QAAQ,CAAC,EAAE;YACpB,IAAI,MAAM,CAAC,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,QAAQ,EAAE,YAAY,CAAC,EAAE;gBAChE,OAAO;oBACL,UAAU,EAAE,QAAQ,CAAC,UAAU;oBAC/B,YAAY,EAAE,iBAAiB,CAAC,QAAQ,CAAC,UAAU,CAAC;iBACrD,CAAA;aACF;YAED,IAAI,MAAM,CAAC,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,QAAQ,EAAE,YAAY,CAAC,IAAI,MAAM,CAAC,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,QAAQ,EAAE,cAAc,CAAC,EAAE;gBAClI,OAAO,QAAQ,CAAA;aAChB;SACF;QACD,OAAO;YACL,UAAU,EAAE,MAAM;YAClB,YAAY,EAAE,QAAQ,CAAC,QAAQ,EAAE;SAClC,CAAA;KACF;IAED,OAAO;QACL,UAAU,EAAE,MAAM;QAClB,YAAY,EAAE,QAAQ,CAAC,QAAQ,EAAE;KAClC,CAAA;AACH,CAAC;AAxBD,oDAwBC;AAED,MAAM,QAAQ,GAAG,UAAU,CAAA;AAC3B,MAAM,oBAAoB,GAAG,CAAC,CAAA;AAC9B,MAAM,qBAAqB,GAAG,CAAC,CAAA,CAAC,sBAAsB;AAEtD,SAAgB,aAAa,CAAC,IAAY;IACxC,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE;QACzB,MAAM,IAAI,KAAK,CAAC,uDAAuD,CAAC,CAAA;KACzE;IAED,MAAM,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAA;IAEjC,IAAI,SAAS,GAAG,CAAC,CAAA;IAEjB,IAAI,SAAS,CAAC,MAAM,KAAK,oBAAoB,IAAI,SAAS,CAAC,MAAM,KAAK,qBAAqB,EAAE;QAC3F,SAAS,GAAG,CAAC,SAAS,CAAC,MAAM,GAAG,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,CAAA;KAC3C;SAAM;QACL,MAAM,IAAI,KAAK,CAAC,uCAAuC,CAAC,CAAA;KACzD;IAED,MAAM,GAAG,GAAG,MAAM,CAAC,KAAK,CAAC,SAAS,CAAC,CAAA;IACnC,GAAG,CAAC,UAAU,CAAC,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC,CAAC,CAAA;IAEvC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,SAAS,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC,EAAE;QAC5C,IAAI,KAAK,GAAG,CAAC,CAAA;QACb,IAAI,KAAK,GAAG,SAAS,CAAC,CAAC,CAAC,CAAA;QACxB,IAAI,KAAK,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE;YACvB,KAAK,IAAI,QAAQ,CAAA;YACjB,KAAK,GAAG,KAAK,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAA;SAC3B;QAED,MAAM,WAAW,GAAG,MAAM,CAAC,KAAK,CAAC,CAAA;QAEjC,IAAI,MAAM,CAAC,KAAK,CAAC,WAAW,CAAC,EAAE;YAC7B,MAAM,IAAI,KAAK,CAAC,kBAAkB,KAAK,6CAA6C,CAAC,CAAA;SACtF;QAED,IAAI,WAAW,IAAI,QAAQ,EAAE;YAC3B,MAAM,IAAI,KAAK,CAAC,uDAAuD,CAAC,CAAA;SACzE;QAED,KAAK,IAAI,WAAW,CAAA;QAEpB,GAAG,CAAC,aAAa,CAAC,KAAK,EAAE,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,CAAC,CAAA;KAC1C;IAED,OAAO,GAAG,CAAA;AACZ,CAAC;AA1CD,sCA0CC","sourcesContent":["/** ******************************************************************************\n *  (c) 2018 - 2023 Zondax AG\n *\n *  Licensed under the Apache License, Version 2.0 (the \"License\");\n *  you may not use this file except in compliance with the License.\n *  You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n *  Unless required by applicable law or agreed to in writing, software\n *  distributed under the License is distributed on an \"AS IS\" BASIS,\n *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *  See the License for the specific language governing permissions and\n *  limitations under the License.\n ******************************************************************************* */\nexport const CHUNK_SIZE = 250\n\nexport const PAYLOAD_TYPE = {\n  INIT: 0x00,\n  ADD: 0x01,\n  LAST: 0x02,\n}\n\nexport const P1_VALUES = {\n  ONLY_RETRIEVE: 0x00,\n  SHOW_ADDRESS_IN_DEVICE: 0x01,\n}\n\nexport const P2_VALUES = {\n  DEFAULT: 0x00,\n}\n\n// noinspection JSUnusedGlobalSymbols\nexport const SIGN_VALUES_P2 = {\n  DEFAULT: 0x00,\n}\n\nexport const ERROR_CODE = {\n  NoError: 0x9000,\n}\n\nexport const enum SignatureType {\n  RawSignature = 0,\n  WrapperSignature = 1,\n}\n\nexport enum LedgerError {\n  U2FUnknown = 1,\n  U2FBadRequest = 2,\n  U2FConfigurationUnsupported = 3,\n  U2FDeviceIneligible = 4,\n  U2FTimeout = 5,\n  Timeout = 14,\n  NoErrors = 0x9000,\n  DeviceIsBusy = 0x9001,\n  ErrorDerivingKeys = 0x6802,\n  ExecutionError = 0x6400,\n  WrongLength = 0x6700,\n  EmptyBuffer = 0x6982,\n  OutputBufferTooSmall = 0x6983,\n  DataIsInvalid = 0x6984,\n  ConditionsNotSatisfied = 0x6985,\n  TransactionRejected = 0x6986,\n  BadKeyHandle = 0x6a80,\n  InvalidP1P2 = 0x6b00,\n  InstructionNotSupported = 0x6d00,\n  AppDoesNotSeemToBeOpen = 0x6e01,\n  UnknownError = 0x6f00,\n  SignVerifyError = 0x6f01,\n}\n\nexport const ERROR_DESCRIPTION = {\n  [LedgerError.U2FUnknown]: 'U2F: Unknown',\n  [LedgerError.U2FBadRequest]: 'U2F: Bad request',\n  [LedgerError.U2FConfigurationUnsupported]: 'U2F: Configuration unsupported',\n  [LedgerError.U2FDeviceIneligible]: 'U2F: Device Ineligible',\n  [LedgerError.U2FTimeout]: 'U2F: Timeout',\n  [LedgerError.Timeout]: 'Timeout',\n  [LedgerError.NoErrors]: 'No errors',\n  [LedgerError.DeviceIsBusy]: 'Device is busy',\n  [LedgerError.ErrorDerivingKeys]: 'Error deriving keys',\n  [LedgerError.ExecutionError]: 'Execution Error',\n  [LedgerError.WrongLength]: 'Wrong Length',\n  [LedgerError.EmptyBuffer]: 'Empty Buffer',\n  [LedgerError.OutputBufferTooSmall]: 'Output buffer too small',\n  [LedgerError.DataIsInvalid]: 'Data is invalid',\n  [LedgerError.ConditionsNotSatisfied]: 'Conditions not satisfied',\n  [LedgerError.TransactionRejected]: 'Transaction rejected',\n  [LedgerError.BadKeyHandle]: 'Bad key handle',\n  [LedgerError.InvalidP1P2]: 'Invalid P1/P2',\n  [LedgerError.InstructionNotSupported]: 'Instruction not supported',\n  [LedgerError.AppDoesNotSeemToBeOpen]: 'App does not seem to be open',\n  [LedgerError.UnknownError]: 'Unknown error',\n  [LedgerError.SignVerifyError]: 'Sign/verify error',\n}\n\nexport function errorCodeToString(statusCode: LedgerError) {\n  if (statusCode in ERROR_DESCRIPTION) return ERROR_DESCRIPTION[statusCode]\n  return `Unknown Status Code: ${statusCode}`\n}\n\nfunction isDict(v: any) {\n  return typeof v === 'object' && v !== null && !(v instanceof Array) && !(v instanceof Date)\n}\n\nexport function processErrorResponse(response: any) {\n  if (response) {\n    if (isDict(response)) {\n      if (Object.prototype.hasOwnProperty.call(response, 'statusCode')) {\n        return {\n          returnCode: response.statusCode,\n          errorMessage: errorCodeToString(response.statusCode),\n        }\n      }\n\n      if (Object.prototype.hasOwnProperty.call(response, 'returnCode') && Object.prototype.hasOwnProperty.call(response, 'errorMessage')) {\n        return response\n      }\n    }\n    return {\n      returnCode: 0xffff,\n      errorMessage: response.toString(),\n    }\n  }\n\n  return {\n    returnCode: 0xffff,\n    errorMessage: response.toString(),\n  }\n}\n\nconst HARDENED = 0x80000000\nconst DEFAULT_DER_PATH_LEN = 6\nconst IDENTITY_DER_PATH_LEN = 4 // m/888'/0'/<account>\n\nexport function serializePath(path: string) {\n  if (!path.startsWith('m')) {\n    throw new Error(`Path should start with \"m\" (e.g \"m/44'/5757'/5'/0/3\")`)\n  }\n\n  const pathArray = path.split('/')\n\n  let allocSize = 0\n\n  if (pathArray.length === DEFAULT_DER_PATH_LEN || pathArray.length === IDENTITY_DER_PATH_LEN) {\n    allocSize = (pathArray.length - 1) * 4 + 1\n  } else {\n    throw new Error(`Invalid path. (e.g \"m/44'/134'/0/0/0\"`)\n  }\n\n  const buf = Buffer.alloc(allocSize)\n  buf.writeUInt8(pathArray.length - 1, 0)\n\n  for (let i = 1; i < pathArray.length; i += 1) {\n    let value = 0\n    let child = pathArray[i]\n    if (child.endsWith(\"'\")) {\n      value += HARDENED\n      child = child.slice(0, -1)\n    }\n\n    const childNumber = Number(child)\n\n    if (Number.isNaN(childNumber)) {\n      throw new Error(`Invalid path : ${child} is not a number. (e.g \"m/44'/461'/5'/0/3\")`)\n    }\n\n    if (childNumber >= HARDENED) {\n      throw new Error('Incorrect child value (bigger or equal to 0x80000000)')\n    }\n\n    value += childNumber\n\n    buf.writeUInt32LE(value, 4 * (i - 1) + 1)\n  }\n\n  return buf\n}\n"]}